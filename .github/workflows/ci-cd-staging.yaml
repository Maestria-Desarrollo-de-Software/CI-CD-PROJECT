name: CI

on:
  push:
    branches:
      - develop
      - dev-ci-cd
    tags:
      - "v*"
  pull_request:

jobs:
  ci:
    name: CI - Quality Gates + Tests + Build
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.4
        env:
          MYSQL_DATABASE: petclinic
          MYSQL_USER: petclinic
          MYSQL_PASSWORD: petclinic
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -proot"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=15

    env:
      SPRING_PROFILES_ACTIVE: mysql
      SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/petclinic?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: petclinic
      SPRING_DATASOURCE_PASSWORD: petclinic

    outputs:
      release_id: ${{ steps.release.outputs.release_id }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Format/Lint (Spotless)
        run: ./gradlew spotlessCheck

      - name: Static Analysis (Checkstyle + SpotBugs)
        run: ./gradlew checkstyleMain checkstyleTest spotbugsMain spotbugsTest

      - name: Tests + Coverage (JaCoCo)
        run: ./gradlew test jacocoTestReport

      - name: Build Artifact (bootJar) - build once
        run: ./gradlew bootJar -x test

      - name: Compute release id
        id: release
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            echo "release_id=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          else
            SHORT_SHA="${GITHUB_SHA:0:8}"
            TS="$(date -u +'%Y%m%d-%H%M%S')"
            echo "release_id=${TS}-${SHORT_SHA}" >> "$GITHUB_OUTPUT"
          fi
                
      - name: Debug release id
        run: |
          echo "release_id = ${{ steps.release.outputs.release_id }}"
          echo "github_ref  = ${{ github.ref }}"
          echo "github_sha  = ${{ github.sha }}"

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: petclinic-jar
          path: build/libs/*.jar
          if-no-files-found: error

      - name: Upload Gradle problems report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: gradle-problems-report
          path: build/reports/problems/

  deploy_staging:
    name: CD - Deploy to Staging
    runs-on: [ self-hosted, staging ]
    needs: ci
    if: github.ref == 'refs/heads/develop'
    environment: staging

    steps:
      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: petclinic-jar
          path: ./artifact

      - name: Deploy (atomic symlink + restart + healthcheck)
        shell: bash
        run: |
          set -euxo pipefail

          APP_ROOT="/var/www/petclinic-staging"
          RELEASE_ID="${{ needs.ci.outputs.release_id }}"
          RELEASE_DIR="${APP_ROOT}/releases/${RELEASE_ID}"

          JAR_SOURCE="$(find ./artifact -name "*.jar" | head -n 1)"
          test -n "${JAR_SOURCE}"
          echo "JAR_SOURCE=${JAR_SOURCE}"

          sudo -n mkdir -p "${RELEASE_DIR}"
          sudo -n cp "${JAR_SOURCE}" "${RELEASE_DIR}/app.jar"

          # symlink atomico
          sudo -n ln -sfn "${RELEASE_DIR}" "${APP_ROOT}/current"

          # restart
          sudo -n systemctl restart petclinic-staging

          # espera + healthcheck (con timeout)
          HOST_IP="$(hostname -I | awk '{print $1}')"
          echo "HOST_IP=${HOST_IP}"

          for i in $(seq 1 90); do
            code="$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 2 --max-time 5 "http://${HOST_IP}:8081/api/health" || true)"
            echo "Health attempt ${i}/90 -> HTTP ${code}"
            if [ "${code}" = "200" ]; then
              echo "STAGING OK"
              exit 0
            fi
            sleep 2
          done

          echo "Healthcheck FAILED. Service status:"
          sudo -n systemctl status petclinic-staging --no-pager -l || true
          echo "Last logs:"
          sudo -n journalctl -u petclinic-staging -n 200 --no-pager -l || true
          echo "Listening ports:"
          sudo -n ss -lntp | grep java || true
          exit 1

      - name: Upload Gradle problems report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
           name: gradle-problems-report
           path: build/reports/problems/